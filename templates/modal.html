<!-- Modal -->
<div id="productModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-black bg-opacity-50">
  <div id="productModalContent" class="bg-gray-800 rounded-lg shadow-lg w-5/6 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto opacity-0 scale-95 transform transition-all duration-150 ease-out">
    <!-- Modal header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-700">
      <div>
        <h3 class="text-xl font-semibold text-white">
          Create New Product
        </h3>
        <p class="text-sm text-gray-400 mt-1">Add a new football product to your store</p>
      </div>
      <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-700 hover:text-white rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideModal()">
        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
        <span class="sr-only">Close modal</span>
      </button>
    </div>
    <!-- Modal body -->
    <div class="px-6 py-4 space-y-6 form-style">
      <form id="productForm">
        <div class="mb-4">
          <label for="name" class="block text-sm font-medium text-gray-300">Product Name</label>
          <input type="text" id="name" name="name" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400" placeholder="Enter product name" required>
        </div>
        
        <div class="mb-4">
          <label for="description" class="block text-sm font-medium text-gray-300">Description</label>
          <textarea id="description" name="description" rows="3" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400" placeholder="Enter product description" required></textarea>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="mb-4">
            <label for="price" class="block text-sm font-medium text-gray-300">Price</label>
            <input type="number" id="price" name="price" min="0" step="0.01" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400" placeholder="0.00" required>
          </div>
          
          <div class="mb-4">
            <label for="brand" class="block text-sm font-medium text-gray-300">Brand</label>
            <input type="text" id="brand" name="brand" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400" placeholder="Enter brand name" required>
          </div>
        </div>

        <div class="mb-4">
          <label for="thumbnail" class="block text-sm font-medium text-gray-300">Thumbnail URL</label>
          <input type="url" id="thumbnail" name="thumbnail" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400" placeholder="https://example.com/image.jpg">
        </div>
        
        <div class="mb-4">
          <label for="category" class="block text-sm font-medium text-gray-300">Category</label>
          <select id="category" name="category" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" onchange="updateSizeChoices()" required>
            <option value="">Choose a category</option>
            <option value="shoes">Football Shoes</option>
            <option value="jersey">Jerseys</option>
            <option value="equipment">Equipment</option>
            <option value="accessories">Accessories</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-300 mb-2">Available Sizes</label>
          <div id="sizeChoicesContainer" class="grid grid-cols-4 gap-2">
            <!-- Size choices will be dynamically populated here -->
          </div>
        </div>

        <div class="mb-4">
          <div class="flex items-center">
            <input id="is_featured" name="is_featured" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
            <label for="is_featured" class="ml-2 text-sm font-medium text-gray-300">Featured Product</label>
          </div>
        </div>
      </form>
    </div>
    <!-- Modal footer -->
    <div class="flex flex-col sm:flex-row gap-4 p-6 border-t border-gray-700 rounded-b">
      <button type="button" id="cancelButton" class="order-2 sm:order-1 px-6 py-3 border border-gray-600 text-gray-300 rounded-md font-medium hover:bg-gray-700 transition-colors text-center" onclick="hideModal()">Cancel</button>
      <button type="submit" id="submitProduct" form="productForm" class="order-1 sm:order-2 flex-1 bg-blue-600 text-white px-6 py-3 rounded-md font-medium hover:bg-blue-700 transition-colors">Add Product</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-black bg-opacity-50">
  <div id="deleteModalContent" class="bg-gray-800 rounded-lg shadow-lg w-11/12 sm:w-96 mx-4 opacity-0 scale-95 transform transition-all duration-150 ease-out">
    <!-- Modal header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-700">
      <div class="flex items-center">
        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mr-3">
          <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L3.732 16.5c-.77.833-.23 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-white">Delete Product</h3>
          <p class="text-sm text-gray-400">This action cannot be undone</p>
        </div>
      </div>
      <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-700 hover:text-white rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideDeleteModal()">
        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
        <span class="sr-only">Close modal</span>
      </button>
    </div>
    
    <!-- Modal body -->
    <div class="p-6">
      <div class="text-center">
        <p class="text-gray-300 mb-2">Are you sure you want to delete this product?</p>
        <p id="deleteProductName" class="text-lg font-semibold text-white mb-4"></p>
        <p class="text-sm text-gray-400 mb-6">This action cannot be undone and will permanently remove the product from your store.</p>
      </div>
      
      <!-- Action buttons -->
      <div class="flex items-center justify-center space-x-4">
        <button type="button" onclick="hideDeleteModal()" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 border border-gray-600 rounded-lg hover:bg-gray-600 hover:text-white focus:ring-2 focus:ring-gray-500 transition-colors">
          Cancel
        </button>
        <button type="button" id="confirmDeleteBtn" onclick="confirmDelete()" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-red-600 rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500 transition-colors">
          <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
          Delete Product
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function showModal() {
    const modal = document.getElementById('productModal');
    const modalContent = document.getElementById('productModalContent');
    const form = document.getElementById('productForm');

    // If not in edit mode, reset form and modal title
    if (!form.dataset.mode || form.dataset.mode !== 'edit') {
        form.reset();
        form.dataset.mode = '';
        form.dataset.productId = '';
        document.querySelector('#productModalContent h3').textContent = 'Create New Product';
    }

    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
        // populate size choices when modal opens
        try { updateSizeChoices(); } catch(e) {}
    }, 50);
}

function hideModal() {
    const modal = document.getElementById('productModal');
    const modalContent = document.getElementById('productModalContent');
    const form = document.getElementById('productForm');

    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');

    setTimeout(() => {
        modal.classList.add('hidden');
        form.reset();
        // Reset form mode
        form.dataset.mode = '';
        form.dataset.productId = '';
        // Reset modal title
        document.querySelector('#productModalContent h3').textContent = 'Create New Product';
    }, 150);
}

// Delete Modal Functions
let productToDelete = null;

function showDeleteModal(productId, productName) {
    const modal = document.getElementById('deleteModal');
    const modalContent = document.getElementById('deleteModalContent');
    const productNameElement = document.getElementById('deleteProductName');
    
    // Store product info for deletion
    productToDelete = { id: productId, name: productName };
    productNameElement.textContent = productName;
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
    }, 50);
}

function hideDeleteModal() {
    const modal = document.getElementById('deleteModal');
    const modalContent = document.getElementById('deleteModalContent');
    
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        productToDelete = null;
    }, 150);
}

async function confirmDelete() {
    if (!productToDelete) return;
    
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const originalText = confirmBtn.innerHTML;
    
    // Show loading state
    confirmBtn.innerHTML = `
        <svg class="animate-spin w-4 h-4 mr-2 inline" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Deleting...
    `;
    confirmBtn.disabled = true;
    
    try {
        const deleteUrl = "{% url 'main:delete_product_ajax' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', productToDelete.id);
        const response = await fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        });
        
        if (response.ok) {
            hideDeleteModal();
            // Refresh products list
            document.dispatchEvent(new CustomEvent('productAdded'));
            try { 
                showToast('Success', `${productToDelete.name} has been deleted successfully!`, 'success'); 
            } catch(e) {
                alert(`${productToDelete.name} has been deleted successfully!`);
            }
        } else {
            throw new Error('Failed to delete product');
        }
    } catch (error) {
        console.error('Error deleting product:', error);
        try { 
            showToast('Error', 'Failed to delete product. Please try again.', 'error'); 
        } catch(e) {
            alert('Error deleting product. Please try again.');
        }
    } finally {
        // Reset button
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    }
}

async function addProduct() {
  const form = document.getElementById('productForm');
  if (!form) return;
  
  const isEditMode = form.dataset.mode === 'edit';
  const productId = form.dataset.productId;
  
  const formData = new FormData(form);
  
  // Ensure price is integer to match server model IntegerField
  const priceInput = form.querySelector('input[name="price"]');
  if (priceInput) {
    const raw = priceInput.value;
    let coerced = 0;
    try { coerced = Math.floor(Number(raw) || 0); } catch(e) { coerced = 0; }
    formData.set('price', String(coerced));
  }

  const sizes = [];
  document.querySelectorAll('input[name="available_sizes"]:checked').forEach(cb => sizes.push(cb.value));
  formData.set('available_sizes', sizes.join(', '));

  const csrftoken = getCookie('csrftoken');

  try {
    // Map form fields to backend expected names
    formData.set('title', formData.get('name'));
    formData.set('content', formData.get('description'));

    let url, method;
    if (isEditMode) {
      url = "{% url 'main:edit_product_ajax' '00000000-0000-0000-0000-000000000000' %}".replace('00000000-0000-0000-0000-000000000000', productId);
      method = 'POST';
    } else {
      url = "{% url 'main:add_product_entry_ajax' %}";
      method = 'POST';
    }

    const response = await fetch(url, {
      method: method,
      headers: csrftoken ? { 'X-CSRFToken': csrftoken } : {},
      body: formData
    });

    if (response.ok) {
      document.getElementById('productForm').reset();
      // Reset form mode
      form.dataset.mode = '';
      form.dataset.productId = '';
      // Reset modal title
      document.querySelector('#productModalContent h3').textContent = 'Create New Product';
      
      hideModal();
      try { 
        const message = isEditMode ? 'Product updated successfully!' : 'Product added successfully!';
        showToast('Success', message, 'success'); 
      } catch(e){}
      document.dispatchEvent(new CustomEvent('productAdded'));
      return true;
    }

    // Otherwise try to parse JSON response for error message
    let payload = null;
    try { payload = await response.json(); } catch(e) { payload = await response.text().catch(()=>null); }

    if (response.ok) {
      // assume success if ok
      document.getElementById('productForm').reset();
      hideModal();
      try { showToast('Success', 'Product added successfully!', 'success'); } catch(e){}
      document.dispatchEvent(new CustomEvent('productAdded'));
      return true;
    } else {
      const msg = (payload && payload.message) ? payload.message : (typeof payload === 'string' ? payload : 'Failed to add product');
      try { showToast('Error', msg, 'error'); } catch(e) { alert(msg); }
      return false;
    }
  } catch (err) {
    console.error('Error:', err);
    try { showToast('Error', 'An error occurred while adding the product', 'error'); } catch(e){ alert('An error occurred while adding the product'); }
    return false;
  }
}

// Attach submit/click handlers
const productForm = document.getElementById('productForm');
if (productForm) {
  productForm.addEventListener('submit', function(e) {
    e.preventDefault();
    addProduct();
  });
}

const submitBtn = document.getElementById('submitProduct');
if (submitBtn) {
  submitBtn.addEventListener('click', function(e) {
    e.preventDefault();
    addProduct();
  });
}

// Helper function to get CSRF token
// Size choices configuration
const CLOTHING_SIZES = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];
const SHOES_SIZES = ['39', '40', '41', '42', '43', '44', '45'];

function updateSizeChoices() {
    const category = document.getElementById('category').value;
    const container = document.getElementById('sizeChoicesContainer');
    
    // Clear existing choices
    container.innerHTML = '';
    
    // Determine which sizes to show
    const sizes = category === 'shoes' ? SHOES_SIZES : CLOTHING_SIZES;
    
    // Create checkbox for each size
    sizes.forEach(size => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        
        div.innerHTML = `
            <input id="size_${size}" 
                   name="available_sizes" 
                   type="checkbox" 
                   value="${size}" 
                   class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded">
            <label for="size_${size}" 
                   class="ml-2 text-sm font-medium text-gray-300">${size}</label>
        `;
        
        container.appendChild(div);
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize size choices when the modal is shown
document.getElementById('productModal').addEventListener('shown.bs.modal', function () {
    updateSizeChoices();
});

// Note: main page listens for 'productAdded' and will refresh itself via PRODUCTS_API_ENDPOINT
// (handlers attached above)
</script>
